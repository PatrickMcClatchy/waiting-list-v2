<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SAGA Waiting List</title>
    <link rel="stylesheet" href="/admin/css/admin.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <div class="container">
                <div class="admin-header-content">
                    <h1 class="admin-title">SAGA Waiting List Admin</h1>
                    <button id="logoutBtn" class="btn btn-danger btn-sm">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>
        
        <div class="container">
            <nav class="admin-nav">
                <ul class="admin-nav-list">
                    <li class="admin-nav-item">
                        <a href="/admin/index.html" class="admin-nav-link active">Main</a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="/admin/settings.html" class="admin-nav-link">Settings</a>
                    </li>
                </ul>
            </nav>
            
            <main class="admin-main">
                <!-- Waiting List Status Toggle -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h2 class="admin-card-title">
                            <svg style="width: 24px; height: 24px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Waiting List Status
                        </h2>
                    </div>
                    
                    <div class="switch-container">
                        <label class="switch tooltip">
                            <input type="checkbox" id="waitingListToggle">
                            <span class="slider"></span>
                            <span class="tooltiptext">Toggle waiting list open/closed</span>
                        </label>
                        <span id="waitingListStatus" class="switch-status">Loading status...</span>
                    </div>
                </div>
                
                <!-- Add New User -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h2 class="admin-card-title">
                            <svg style="width: 24px; height: 24px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                            </svg>
                            Add New User
                        </h2>
                    </div>
                    
                    <form id="addUserForm">
                        <div class="d-flex" style="gap: 15px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label for="name" class="form-label">
                                    <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    Name
                                </label>
                                <input type="text" id="name" name="name" class="form-control" required>
                            </div>
                            
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label for="email" class="form-label">
                                    <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    Email or Phone
                                </label>
                                <input type="text" id="email" name="email" class="form-control">
                            </div>
                        </div>
                        
                        <div class="d-flex" style="gap: 15px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label for="language" class="form-label">
                                    <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                                    </svg>
                                    Language
                                </label>
                                <input type="text" id="language" name="language" class="form-control" required>
                            </div>
                            
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label for="comment" class="form-label">
                                    <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                    </svg>
                                    Comment (Optional)
                                </label>
                                <input type="text" id="comment" name="comment" class="form-control">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-add">
                            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Add User to List
                        </button>
                    </form>
                </div>
                
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h2 class="admin-card-title">
                            <svg style="width: 24px; height: 24px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                            </svg>
                            Current Waiting List
                        </h2>
                    </div>
                    <div class="admin-card-header">
                        <div class="admin-card-title">
                                                               <!-- Buttons for Refresh and Export -->
                             <div class="btn-group" style="margin-top: 15px;">
                                 <button id="refreshBtn" class="btn btn-refresh">
                                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                             Refresh List
                                                </button>
                                                <button id="exportBtn" class="btn btn-export">
                                            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                        Export List
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table id="waitingListTable" class="admin-table">
                            <thead>
                                <tr>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                                        </svg>
                                        Position
                                    </th>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        Entry Date
                                    </th>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                        Name
                                    </th>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                        Contact
                                    </th>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                                        </svg>
                                        Language
                                    </th>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                        </svg>
                                        Comment
                                    </th>
                                    <th>
                                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                                        </svg>
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">Loading waiting list...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    Confirm Action
                </h3>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to remove this user?</p>
            </div>
            <div class="modal-footer">
                <button id="cancelBtn" class="btn btn-secondary">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Cancel
                </button>
                <button id="confirmBtn" class="btn btn-danger">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Confirm
                </button>
            </div>
        </div>
    </div>
                
                <!-- Clear Waiting List -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h2 class="admin-card-title">
                            <svg style="width: 24px; height: 24px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Clear Waiting List
                        </h2>
                    </div>
                    
                    <div class="alert alert-warning">
                        <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <strong>Warning:</strong> This action will remove all users from the waiting list. Make sure you have exported the current list before proceeding.
                    </div>
                    
                    <button id="clearListBtn" class="btn btn-clear">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Clear All Users
                    </button>
                </div>


                <!-- Backup Info -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h2 class="admin-card-title">
                            <svg style="width: 24px; height: 24px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            Last Backup
                        </h2>
                        <button onclick="viewLastBackup()" class="btn btn-view btn-sm">
                            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            View Backup
                        </button>
                    </div>
                    
                    <p>
                        <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Last backup date: <strong id="backupDate">Loading...</strong>
                    </p>
                </div>
    
    <!-- Clear List Confirmation Modal -->
    <div id="clearListModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear Waiting List
                </h3>
            </div>
            <div class="modal-body">
                <p><strong>Warning:</strong> This will remove everyone from the waiting list.</p>
                <p>A backup will be made automatically, but it’s a good idea to export the list first.</p>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="exportConfirmCheckbox" style="margin-right: 10px;">
                        <label for="exportConfirmCheckbox">I’ve exported the current waiting list</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelClearBtn" class="btn btn-secondary">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Cancel
                </button>
                <button id="confirmClearBtn" class="btn btn-danger" disabled>
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear List
                </button>
            </div>
        </div>
    </div>
    
    <!-- Include navigation script -->
    <script src="/admin/js/navigation.js"></script>
    
    <script>
        // Dashboard-specific functionality
        function initializeDashboard() {
            checkLoginStatus();
            loadWaitingList();
            loadToggleState();
            loadBackupInfo();
            
            // Check scheduled open times
            fetch('/admin/api_proxy.php?endpoint=scheduled_open.php')
                .then(response => response.json())
                .then(data => {
                    console.log('Scheduled open check completed:', data);
                })
                .catch(error => {
                    console.error('Error checking scheduled open times:', error);
                });
            
            // Event listeners
            document.getElementById('waitingListToggle').addEventListener('change', updateToggleState);
            document.getElementById('addUserForm').addEventListener('submit', addUser);
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadWaitingList();
                loadToggleState();
                loadBackupInfo();
                showPopupMessage('Data refreshed');
            });
            document.getElementById('exportBtn').addEventListener('click', exportWaitingList);
            document.getElementById('logoutBtn').addEventListener('click', () => {
                window.location.href = '/admin/api_proxy.php?endpoint=logout.php';
            });
            document.getElementById('clearListBtn').addEventListener('click', clearWaitingList);
        }
        
        // Make initializeDashboard globally available
        window.initializeDashboard = initializeDashboard;
        
        // Check login status
        function checkLoginStatus() {
            fetch('/admin/api_proxy.php?endpoint=check_session.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.loggedIn) {
                        window.location.href = '/admin/login.html';
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    alert('An error occurred. Please try again.');
                    window.location.href = '/admin/login.html';
                });
        }
        
        // Show popup message
        function showPopupMessage(message, type = 'success') {
            const popup = document.createElement('div');
            popup.className = `popup-message ${type === 'error' ? 'error' : ''}`;
            popup.innerText = message;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.remove();
                }, 300);
            }, 3000);
        }
        
        // Load waiting list
        function loadWaitingList() {
            fetch('/admin/api_proxy.php?endpoint=get_waiting_list.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayWaitingList(data.data);
                    } else {
                        console.error("Failed to load the waiting list.");
                        showPopupMessage('Failed to load waiting list', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading waiting list:', error);
                    showPopupMessage('Error loading waiting list', 'error');
                });
        }
        
    
// Display waiting list
function displayWaitingList(users) {
    const tableBody = document.querySelector('#waitingListTable tbody');
    
    if (users.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No users in the waiting list</td></tr>`;
        return;
    }
    
    tableBody.innerHTML = '';
    
    users.forEach(user => {
        // Format the date from Unix timestamp
        const entryDate = user.time ? new Date(user.time * 1000).toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : '-';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="status-indicator">#${user.position}</span></td>
            <td>${entryDate}</td>
            <td>${user.name}</td>
            <td>${user.email_or_phone || '-'}</td>
            <td>${user.language || '-'}</td>
            <td>${user.comment || '-'}</td>
            <td>
                <div class="admin-table-actions">
                    <button class="btn btn-danger btn-sm" onclick="removeUser(${user.id})">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Remove
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}
        
        // Load toggle state
        function loadToggleState() {
            fetch('/admin/api_proxy.php?endpoint=get_waiting_list_state.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const isOpen = data.isOpen === 1;
                        document.getElementById('waitingListToggle').checked = isOpen;
                        updateSwitchStatus(isOpen);
                    } else {
                        showPopupMessage('Failed to fetch waiting list state', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching waiting list state:', error);
                    showPopupMessage('Error fetching waiting list state', 'error');
                });
        }
        
        // Update switch status
        function updateSwitchStatus(isOpen) {
    const statusElement = document.getElementById('waitingListStatus');
    const switchContainer = document.querySelector('.switch-container');
    const switchElement = document.querySelector('.switch');

    if (isOpen) {
        // Update status text and styles
        statusElement.innerHTML = `
            <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Waiting list is OPEN
        `;
        statusElement.className = 'switch-status open';
        switchElement.classList.add('open');
        switchElement.classList.remove('closed');

        // Add green shadow to switch container
        switchContainer.classList.add('open');
        switchContainer.classList.remove('closed');
    } else {
        // Update status text and styles
        statusElement.innerHTML = `
            <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Waiting list is CLOSED
        `;
        statusElement.className = 'switch-status closed';
        switchElement.classList.add('closed');
        switchElement.classList.remove('open');

        // Add red shadow to switch container
        switchContainer.classList.add('closed');
        switchContainer.classList.remove('open');
    }
}
        // Update toggle state
        function updateToggleState() {
            const isOpen = document.getElementById('waitingListToggle').checked ? 1 : 0;
            
            fetch('/admin/api_proxy.php?endpoint=toggle_waiting_list.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `isOpen=${isOpen}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSwitchStatus(isOpen);
                    showPopupMessage(`Waiting list is now ${isOpen ? 'open' : 'closed'}`);
                } else {
                    showPopupMessage('Failed to update waiting list state', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating waiting list state:', error);
                showPopupMessage('Error updating waiting list state', 'error');
            });
        }
        
        // Add user
        function addUser(event) {
            event.preventDefault();
            
            const formData = new FormData(document.getElementById('addUserForm'));
            const submitBtn = event.submitter;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Adding...
            `;
            
            fetch('/admin/api_proxy.php?endpoint=add_user_admin.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('addUserForm').reset();
                    loadWaitingList();
                    showPopupMessage('User added successfully');
                } else {
                    showPopupMessage(data.message || 'Failed to add user', 'error');
                }
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add User to List
                `;
            })
            .catch(error => {
                console.error('Error adding user:', error);
                showPopupMessage('Error adding user', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add User to List
                `;
            });
        }
        
        // Remove user
        function removeUser(userId) {
            const modal = document.getElementById('confirmationModal');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            // Show modal
            modal.classList.add('active');
            
            // Set up confirm button
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                
                fetch('/admin/api_proxy.php?endpoint=remove_user.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${userId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadWaitingList();
                        showPopupMessage('User removed successfully');
                    } else {
                        showPopupMessage('Failed to remove user', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error removing user:', error);
                    showPopupMessage('Error removing user', 'error');
                });
            };
            
            // Set up cancel button
            cancelBtn.onclick = function() {
                modal.classList.remove('active');
            };
            
            // Close modal when clicking outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            };
        }
        
        // Load backup info
        function loadBackupInfo() {
            fetch('/admin/api_proxy.php?endpoint=get_backup_info.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('backupDate').textContent = data.backup_date;
                    } else {
                        document.getElementById('backupDate').textContent = 'No backup found';
                    }
                })
                .catch(error => {
                    console.error('Error fetching backup info:', error);
                    document.getElementById('backupDate').textContent = 'Error loading backup info';
                });
        }
        
        // Export waiting list
        function exportWaitingList() {
            // Open the export in a new window
            window.open('/admin/api_proxy.php?endpoint=export_waiting_list.php', '_blank');
        }
        
        // View last backup
        function viewLastBackup() {
            fetch('/admin/api_proxy.php?endpoint=get_backup_list.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.backups && data.backups.length > 0) {
                        const latestBackup = data.backups[0];
                        window.open(`/admin/api_proxy.php?endpoint=export_backup.php&file=${latestBackup.file}`, '_blank');
                    } else {
                        showPopupMessage('No backup available', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching backup list:', error);
                    showPopupMessage('Error fetching backup list', 'error');
                });
        }
        
        // Clear waiting list
        function clearWaitingList() {
            const modal = document.getElementById('clearListModal');
            const confirmBtn = document.getElementById('confirmClearBtn');
            const cancelBtn = document.getElementById('cancelClearBtn');
            const checkbox = document.getElementById('exportConfirmCheckbox');
            
            // Reset checkbox state
            checkbox.checked = false;
            confirmBtn.disabled = true;
            
            // Show modal
            modal.classList.add('active');
            
            // Enable/disable confirm button based on checkbox
            checkbox.onchange = function() {
                confirmBtn.disabled = !this.checked;
            };
            
            // Set up confirm button
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                
                // Show loading state
                showPopupMessage('Processing...', 'warning');
                
                fetch('/admin/api_proxy.php?endpoint=clear_waiting_list.php', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadWaitingList();
                        loadBackupInfo();
                        showPopupMessage('Waiting list cleared successfully');
                    } else {
                        showPopupMessage('Failed to clear waiting list: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error clearing waiting list:', error);
                    showPopupMessage('Error clearing waiting list', 'error');
                });
            };
            
            // Set up cancel button
            cancelBtn.onclick = function() {
                modal.classList.remove('active');
            };
            
            // Close modal when clicking outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            };
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });
    </script>
</body>
</html>